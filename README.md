# 2410-17-site
Бэкенд проекта 2410-17 Затонская ТЭЦ на основе проекта 2312-22

Бэкенд пользовательского приложения и административная панель.

## ОГЛАВЛЕНИЕ

[Инструкция по локальному развертыванию](#инструкция-по-локальному-развертыванию)

[Инструкция по локальному запуску](#инструкция-по-локальному-запуску)

[Инструкция по заливке настроек сигналов из xls в базу данных](#инструкция-по-заливке-настроек-сигналов-из-xls-в-базу-данных)

[Устранение некоторых ошибок](#устранение-некоторых-ошибок)


## **Инструкция по локальному развертыванию:

0. Должен быть установлен интерпретатор CPython 3.10.13 и менеджер пакетов pip
1. Обновить pip

        python.exe -m pip install --upgrade pip
2. Установить poetry.

        pip install poetry

3. Добавить соответствующую директорию расположения poetry.

    - Для Windows

            {Путь расположения файлов требуемой версии Python}\Scripts
    - Для Unix

                $HOME/.local/bin
4. Склонировать репозиторий.
5. Установить зависимости.

    - Основные

            poetry install
    
    - Для разработки

            poetry install --with dev
6. ВНИМАНИЕ! Запросы значений сигналов выполняются к VictoriaMetrics. Перед запуском убедитесь что у вас корректно настроены параметры в .env:

    `VM_ADDRESS = адрес для запросов значений сигналов`

    `VM_PREFIX = префикс метрик значений сигналов`

    `VML_ADDRESS = адрес VictoriaLogs для запросов диагностических сообщений`

    `VML_PROJECT_ID = идентификатор базы диагностических сообщений`

7. ВНИМАНИЕ! Для работы сервиса загрузки данных с прибора LASER необходимо задать следующую переменную окружения:

    `LASER_SERVICE = адрес сервиса интеграции с газоанализатором Лазер
    в формате 'http://{IP}:PORT'`

8. На примере .env.example создать в корне проекта файл .env. Задать реальные 
значения переменным.
    - в переменной TIME_ZONE должен указываться часовой пояс сервера
     (международное его название). При отсутствии этой переменной используется значение 'Europe/Moscow';
    - в переменной LEVEL_LOG должен указываться уровень логирования сервера из
     списка ('DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'). При отсутствии этой переменной используется значение 'DEBUG'.
     - в переменной SETTINGS_DB указать URL используемой базы данных.
     - <a name="setting-var-csrf-trusted-origins"></a> ПРИ ИСПОЛЬЗОВАНИИ NGINX!
        - вариант 1: Добавить в NGINX настройки

                location / {
                        ...
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        ...
                }
        - вариант 2: В переменной CSRF_TRUSTED_ORIGINS указать адрес хоста приложения предоставленный клиентам. Например, если сайт будет доступен клиентам с адреса 10.0.12.100, то значение этой переменной должно быть hhtp://10.0.12.100. Если таких адресов несколько, то необходимо перечислить их все через ','.



## **Инструкция по локальному запуску:
1. Находясь в корневой папке проекта активировать виртуальное окружение

        poetry shell
2. Вкл/Выкл режим отладки
   
   - Вкл - в .env задать любое значение переменной DJANGO_DEBUG
   - Выкл - в .env удалить значение у переменной DJANGO_DEBUG

Запустить веб сервер командой

   - если используется режим отладки или сторонний Web-server

                python main/manage.py runserver 0.0.0.0:8000

   - если режим отладки отключен и необходимо использовать встроенный обработчик статических файлов (не рекомендуется)

                python main/manage.py runserver 0.0.0.0:8000 --insecure

## **Инструкция по заливке настроек сигналов из xls в базу данных
1. Скачать в формате Microsoft Excel документы:

    Список сигналов для данного проекта

    [Data model](https://docs.google.com/spreadsheets/d/1oVM_dxFPFSuh0j8WJKKQRTLm9MALCT0l4U0nFldKeCw/edit#gid=237284184)
2. Задать в .env значения переменных:

    `SIGNALS_FILE = "полный путь к файлу списка сигналов"`
    
    `DATA_MODEL = "полный путь к файлу Data model"`
    
    `UI_MODEL = "полный путь к файлу UI model"`
    
    `SIGNALS_TO_DB = 
    {'False', если необходимо НЕ сохранять настройки сигналов в БД (тестовый прогон)} |
        {'True', если необходимо сохранить настройки сигналов в БД}`
3. Находясь в корневой папке проекта 2312-25-site активировать виртуальное окружение

        poetry shell
4. Находясь в виртуальном окружении запустить скрипт

        main\signals_from_xls_to_db_3.py
5. Проанализировать результат работы скрипта изучив логи create*.log в папке /logs

## **Устранение некоторых ошибок:
1. При входе в админ-панель появляется CSRF ошибка.
   - убедиться что вы используете правильный адрес приложения;
   - если используется NGINX, проверить настройки связанные с 
        [ипользованием NGINX](#setting-var-csrf-trusted-origins).
